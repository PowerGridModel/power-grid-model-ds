# SPDX-FileCopyrightText: Contributors to the Power Grid Model project <powergridmodel@lfenergy.org>
#
# SPDX-License-Identifier: MPL-2.0


name: Check Code Quality

on:
  # run pipeline from another workflow
  workflow_call:
    inputs:
      update_dependencies:
        type: boolean
        description: Update dependencies to their latest version
        default: false
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-code-quality
  cancel-in-progress: true

jobs:
  check-code-quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        if: ${{ always() }}
        with:
          activate-environment: true
          enable-cache: true

      - name: install poe
        if: ${{ always() }}
        run: uv tool install poethepoet

      - name: Install dependencies
        if: ${{ always() }}
        run: uv sync --frozen --dev

      - name: Update dependencies
        if: ${{ inputs.update_dependencies && always() }}
        run: uv sync --upgrade --dev

      - name: lint
        if: ${{ always() }}
        run: poe lint --check
      - name: format
        if: ${{ always() }}
        run: poe format --check
      - name: lock
        if: ${{ always() }}
        run: poe lock
      - name: type
        if: ${{ always() }}
        run: poe type
      - name: cover
        if: ${{ always() }}
        run: poe cover
      - name: report
        if: ${{ always() }}
        run: poe report

      - name: Actually stop now if any quality control failed
        if: ${{ failure() }}
        run: exit 1